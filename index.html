<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <meta name="description" content="HTML5 Testseite" />
    <meta name="author" content="Timo" />
    <title>HTML5 Offline</title>
    <link rel="stylesheet" href="styles.css" />
    <!-- <script src="js/scripts.js"></script> -->
  </head>
  <body>
    <header>
        <span>HTML5 Offline</span>
    </header>
    <button id="new-note-btn">+</button>
    <div id="popup">
        <h2>New Note:</h2>
        <form id="new-note-form">
            <label for="new-note-input">Note:</label>
            <input type="text" id="new-note-input" name="new-note" required>
            <button type="submit">Save</button>
        </form>
    </div>
    <h3>Hello World</h3>
    <p id="greeting">Nice to meet you!</p>
    <p class="text">This is a text!</p>
    <p class="text2">This is for Rainer!</p>
    <div id="notes-container">
      <h2>Stored Notes:</h2>
      <ul id="notes-list"></ul>
    </div>
  </body>
  <footer>
    <span id="status-dot"></span>
    <span id="status-message"></span>
  </footer>
  <!-- Service Worker -->
  <script>
    document.addEventListener('DOMContentLoaded', function () {
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('service-worker.js')
                    .then(function(registration) {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(function(error) {
                        console.error('Service Worker registration failed:', error);
                    });

                // Add an event listener to detect the online/offline status
                window.addEventListener('online', updateStatus);
                window.addEventListener('offline', updateStatus);

                // Initial status update
                updateStatus();

                // IndexedDB setup
                var db;
                var request = indexedDB.open('MyDatabase', 1);

                request.onupgradeneeded = function(event) {
                    db = event.target.result;
                    var objectStore = db.createObjectStore('myData', { keyPath: 'id', autoIncrement: true });
                };

                request.onsuccess = function(event) {
                    db = event.target.result;

                    // Retrieve and display locally stored notes on page load
                    displayStoredNotes();
                };

                function saveDataLocally(data) {
                    var transaction = db.transaction(['myData'], 'readwrite');
                    var objectStore = transaction.objectStore('myData');
                    var request = objectStore.add(data);

                    request.onsuccess = function(event) {
                        console.log('Data added locally.');
                    };

                    request.onerror = function(event) {
                        console.error('Error adding data locally.');
                    };
                }

                function appendNoteToList(data) {
                    const notesList = document.getElementById('notes-list');
                    const listItem = document.createElement('li');
                    listItem.className = 'note';
                    listItem.innerHTML = `
                        <span>${data.note}</span>
                        <span class="delete-icon" onclick="deleteNote('${data.note}')">&#128465;</span>
                    `;
                    notesList.appendChild(listItem);
                }


                function updateStatus() {
                    const statusMessage = document.getElementById('status-message');
                    const statusDot = document.getElementById('status-dot');
                    if (navigator.onLine) {
                        statusMessage.textContent = 'Online';
                        //statusMessage.style.color = 'green';
                        statusDot.style.backgroundColor = 'green';
                    } else {
                        statusMessage.textContent = 'Offline';
                        //statusMessage.style.color = 'red';
                        statusDot.style.backgroundColor = 'red';
                    }
                }

                function displayStoredNotes() {
                    const transaction = db.transaction(['myData'], 'readonly');
                    const objectStore = transaction.objectStore('myData');
                    const request = objectStore.getAll();

                    request.onsuccess = function (event) {
                        const notes = event.target.result;
                        notes.forEach(appendNoteToList);
                    };
                }

                window.deleteNote = function(note) {
                    if (confirm(`Do you really want to delete the note "${note}"?`)) {
                        // Delete the note locally
                        deleteNoteLocally(note);

                        // Update the UI by removing the deleted note
                        const noteElements = document.querySelectorAll('.note span:first-child');
                        noteElements.forEach(function (element) {
                            if (element.textContent === note) {
                                element.parentElement.remove();
                            }
                        });
                    }
                };

                function deleteNoteLocally(note) {
                    const transaction = db.transaction(['myData'], 'readwrite');
                    const objectStore = transaction.objectStore('myData');
                    
                    const request = objectStore.openCursor();
                    
                    request.onsuccess = function(event) {
                        const cursor = event.target.result;

                        if (cursor) {
                            if (cursor.value.note === note) {
                                cursor.delete();
                                console.log('Note deleted locally.');
                                return;
                            }

                            cursor.continue();
                        } else {
                            console.error('Note not found for deletion.');
                        }
                    };

                    request.onerror = function(event) {
                        console.error('Error deleting note locally.');
                    };
                }
            }

            // Handle user input and save locally
            const noteForm = document.getElementById('new-note-form');
            const noteInput = document.getElementById('new-note-input');
            const notesList = document.getElementById('notes-list');
            const popup = document.getElementById('popup'); 

            noteForm.addEventListener('submit', function (event) {
                event.preventDefault();

                const note = noteInput.value.trim();
                if (note) {
                    // Save the note locally
                    saveDataLocally({ note: note });

                    // Update the UI
                    appendNoteToList({ note: note });

                    // Clear the input field
                    noteInput.value = '';

                    // Close the popup
                    popup.style.display = 'none';
                }
            });

            // Show the popup when the plus button is clicked
            const newNoteBtn = document.getElementById('new-note-btn');
            // const popup = document.getElementById('popup'); // Removed this line (already defined above)

            newNoteBtn.addEventListener('click', function () {
                popup.style.display = 'block';
            });

            // Close the popup when the form is submitted
            // const newNoteForm = document.getElementById('new-note-form'); // Removed this line (already defined above)
            // const newNoteInput = document.getElementById('new-note-input'); // Removed this line (already defined above)
            
            newNoteForm.addEventListener('submit', function (event) {
                event.preventDefault();
                const note = newNoteInput.value.trim();
                if (note) {
                    // Save the new note locally
                    saveDataLocally({ note: note });

                    // Update the UI
                    appendNoteToList({ note: note });

                    // Clear the input field
                    newNoteInput.value = '';

                    // Close the popup
                    popup.style.display = 'none';
                }
            });
        });
  </script>
</html>